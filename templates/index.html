<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Translation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding-top: 2rem; }
        .container { background-color: #1e1e1e; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 90%; max-width: 700px; }
        h1 { color: #bb86fc; text-align: center; margin-bottom: 1rem; }
        .header-actions { text-align: center; margin-bottom: 2rem; }
        #clearHistoryBtn { background-color: #555; color: white; padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 15px; border: none; cursor: pointer; }
        .lang-selector { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem;}
        .form-group { flex-grow: 1; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #a0a0a0; font-weight: bold;}
        select, textarea { width: 100%; padding: 0.8rem; border-radius: 6px; border: 1px solid #333; background-color: #2c2c2c; color: #e0e0e0; font-size: 1rem; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px; }
        .buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
        button { padding: 1rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        #speakBtn { flex-grow: 1; background-color: #03dac6; color: #121212; }
        #speakBtn.listening { background-color: #cf6679; }
        #translateBtn { flex-grow: 1; background-color: #bb86fc; color: #121212; }
        .swap-controls { display: flex; flex-direction: column; gap: 0.5rem; align-items: center; }
        .swap-controls button { background: none; border: 1px solid #bb86fc; color: #bb86fc; font-size: 1.5rem; padding: 0.5rem 1rem; }
        #roleToggleBtn { font-size: 0.8rem; padding: 0.5rem; border-radius: 50%; width: 50px; height: 50px; }
        button:disabled { background-color: #444; cursor: not-allowed; }
        #historyContainer { margin-top: 2rem; max-height: 40vh; overflow-y: auto; padding-right: 1rem; }
        .history-item { margin-bottom: 1.5rem; background-color: #2c2c2c; padding: 1rem; border-radius: 6px; }
        .history-item p { margin: 0.5rem 0; word-wrap: break-word; }
        .history-item .role-label { color: #a0a0a0; font-size: 0.9em; font-weight: bold; }
        .history-item .text { font-size: 1.1em; }
        .history-item .actions { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .actions button { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        .actions .summarizeBtn { background-color: #3f51b5; color: white; }
        .actions .explainBtn { background-color: #4CAF50; color: white; }
        .loader { text-align: center; display: none; margin-top: 1rem; }
        audio { width: 100%; margin-top: 1rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #2c2c2c; padding: 2rem; border-radius: 8px; max-width: 500px; width: 80%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .modal-content h3 { margin-top: 0; color: #bb86fc; }
        .modal-content .lang-section { margin-bottom: 1rem; }
        .modal-content .lang-label { font-weight: bold; color: #03dac6; }
        .modal-close { float: right; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="container">
            <h1>Healthcare Translation</h1>
            <div class="header-actions"><button id="clearHistoryBtn">Clear History</button></div>
            <div class="lang-selector">
                <div class="form-group"><label id="leftRoleLabel"></label><select id="leftLangSelect"><option value="en">English</option><option value="es">Spanish</option><option value="fr">French</option><option value="de">German</option><option value="hi">Hindi</option><option value="ta">Tamil</option></select></div>
                <div class="swap-controls"> <button id="roleToggleBtn" title="Toggle Roles">ðŸ©º/ðŸ‘¤</button> <button id="langSwapBtn" title="Swap Languages">â‡„</button> </div>
                <div class="form-group"><label id="rightRoleLabel"></label><select id="rightLangSelect"><option value="ta">Tamil</option><option value="es">Spanish</option><option value="fr">French</option><option value="de">German</option><option value="hi">Hindi</option><option value="en">English</option></select></div>
            </div>
            <div class="form-group"><label for="inputText">Text to Translate</label><textarea id="inputText" placeholder="Enter text or use the microphone..."></textarea></div>
            <div class="buttons"><button id="speakBtn">Start Speaking</button><button id="translateBtn">Translate & Speak</button></div>
            <div class="loader" id="loader">Processing...</div>
            <div id="historyContainer"></div>
            <audio id="audioPlayer" controls></audio>
        </div>
    </div>
    <div id="aiModal" class="modal-overlay">
        <div class="modal-content"><span class="modal-close" id="modalCloseBtn">&times;</span><h3 id="modalTitle">AI Insight</h3><div id="modalBody"></div></div>
    </div>

    <script>
        const el = {
            // ... (selectors for all buttons, inputs, etc.)
            speakBtn: document.getElementById('speakBtn'), translateBtn: document.getElementById('translateBtn'), inputText: document.getElementById('inputText'), historyContainer: document.getElementById('historyContainer'), audioPlayer: document.getElementById('audioPlayer'), loader: document.getElementById('loader'), clearHistoryBtn: document.getElementById('clearHistoryBtn'), 
            leftRoleLabel: document.getElementById('leftRoleLabel'), rightRoleLabel: document.getElementById('rightRoleLabel'), leftLangSelect: document.getElementById('leftLangSelect'), rightLangSelect: document.getElementById('rightLangSelect'),
            langSwapBtn: document.getElementById('langSwapBtn'), roleToggleBtn: document.getElementById('roleToggleBtn'),
            aiModal: document.getElementById('aiModal'), modalCloseBtn: document.getElementById('modalCloseBtn'), modalTitle: document.getElementById('modalTitle'), modalBody: document.getElementById('modalBody')
        };

        // --- State Management ---
        let state = {
            left: { role: 'Doctor' },
            right: { role: 'Patient' }
        };

        function updateUI() {
            el.leftRoleLabel.textContent = state.left.role;
            el.rightRoleLabel.textContent = state.right.role;
        }

        // --- Event Listeners ---
        el.langSwapBtn.addEventListener('click', () => { const temp = el.leftLangSelect.value; el.leftLangSelect.value = el.rightLangSelect.value; el.rightLangSelect.value = temp; });
        el.roleToggleBtn.addEventListener('click', () => { const temp = state.left.role; state.left.role = state.right.role; state.right.role = temp; updateUI(); });
        el.clearHistoryBtn.addEventListener('click', () => { el.historyContainer.innerHTML = ''; el.audioPlayer.src = ''; });
        el.modalCloseBtn.addEventListener('click', () => { el.aiModal.style.display = 'none'; });
        el.aiModal.addEventListener('click', (e) => { if (e.target === el.aiModal) { el.aiModal.style.display = 'none'; } });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const r = new SpeechRecognition(); r.continuous = true; r.interimResults = true;
            el.speakBtn.addEventListener('click', () => {
                if (el.speakBtn.classList.contains('listening')) { r.stop(); } else { el.inputText.value = ''; r.lang = el.leftLangSelect.value; r.start(); }
            });
            r.onstart = () => { el.speakBtn.textContent = 'Stop Recording'; el.speakBtn.classList.add('listening'); };
            r.onend = () => { el.speakBtn.textContent = 'Start Speaking'; el.speakBtn.classList.remove('listening'); };
            r.onresult = (e) => { el.inputText.value = Array.from(e.results).map(res => res[0]).map(res => res.transcript).join(''); };
            r.onerror = (e) => { console.error("Speech error:", e.error); alert(`Speech error: ${e.error}`); };
        } else { el.speakBtn.disabled = true; el.speakBtn.textContent = 'Mic Not Supported'; }

        el.translateBtn.addEventListener('click', async () => {
            if (!el.inputText.value) { alert('Please enter text first.'); return; }
            el.loader.style.display = 'block'; el.translateBtn.disabled = true;
            try {
                const fd = new FormData(); fd.append('text', el.inputText.value); fd.append('input_lang_code', el.leftLangSelect.value); fd.append('output_lang_code', el.rightLangSelect.value);
                const res = await fetch('/translate/', { method: 'POST', body: fd });
                if (!res.ok) throw new Error('Translation failed');
                const data = await res.json();
                addHistoryItem(state.left.role, data.original_text, state.right.role, data.translated_text, data.original_lang_code, data.output_lang_code);
                el.inputText.value = '';
                const ttsRes = await fetch('/text-to-speech/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: data.translated_text, lang_code: data.output_lang_code }) });
                if (ttsRes.ok) { const blob = await ttsRes.blob(); el.audioPlayer.src = URL.createObjectURL(blob); try { await el.audioPlayer.play(); } catch (err) { console.error("Autoplay failed:", err); } }
            } catch (err) { console.error('Processing error:', err); alert('An error occurred.'); } finally { el.loader.style.display = 'none'; el.translateBtn.disabled = false; }
        });

        el.historyContainer.addEventListener('click', async (event) => {
            const button = event.target; const text = button.dataset.text; if (!text) return;
            const originalLang = button.dataset.originalLang; const targetLang = button.dataset.targetLang;
            let endpoint = '', title = '', resKey1 = '', resKey2 = '';
            if (button.classList.contains('summarizeBtn')) { endpoint = '/summarize/'; title = 'AI Summary'; resKey1 = 'summary_original_lang'; resKey2 = 'summary_target_lang'; } 
            else if (button.classList.contains('explainBtn')) { endpoint = '/explain-medication/'; title = 'AI Medication Explainer'; resKey1 = 'explanation_original_lang'; resKey2 = 'explanation_target_lang'; } 
            else { return; }
            button.textContent = '...'; button.disabled = true;
            try {
                const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, original_lang: originalLang, target_lang: targetLang }) });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail); }
                const data = await res.json();
                showModal(title, data[resKey1], data[resKey2], originalLang, targetLang);
            } catch (err) { console.error('AI feature error:', err); alert(`Failed: ${err.message}`); } finally { button.textContent = button.classList.contains('summarizeBtn') ? 'Summarize' : 'Explain Medication'; button.disabled = false; }
        });

        function addHistoryItem(fromRole, fromText, toRole, toText, fromLang, toLang) {
            const item = document.createElement('div'); item.className = 'history-item';
            item.innerHTML = `
                <p class="role-label">${fromRole} (${fromLang}):</p>
                <p class="text">${fromText}</p>
                <p class="role-label">${toRole} (${toLang}):</p>
                <p class="text translated">${toText}</p>
                <div class="actions">
                    <button class="summarizeBtn" data-text="${toText}" data-original-lang="${fromLang}" data-target-lang="${toLang}">Summarize</button>
                    <button class="explainBtn" data-text="${toText}" data-original-lang="${fromLang}" data-target-lang="${toLang}">Explain Medication</button>
                </div>`;
            el.historyContainer.prepend(item);
        }

        function showModal(title, content1, content2, lang1, lang2) {
            el.modalTitle.textContent = title;
            el.modalBody.innerHTML = `
                <div class="lang-section"><p class="lang-label">${lang1.toUpperCase()}:</p><p>${content1}</p></div>
                <div class="lang-section"><p class="lang-label">${lang2.toUpperCase()}:</p><p>${content2}</p></div>
            `;
            el.aiModal.style.display = 'flex';
        }

        // Initial UI setup
        updateUI();
    </script>
</body>
</html>