<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Translation</title>
    <style>
        :root { --main-bg: #121212; --surface-bg: #1e1e1e; --primary-color: #bb86fc; --secondary-color: #03dac6; --text-color: #e0e0e0; --subtle-text: #a0a0a0; --border-color: #333; --error-color: #cf6679; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--main-bg); color: var(--text-color); margin: 0; }
        .main-container { display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 2rem 1rem; }
        .container { background-color: var(--surface-bg); padding: 2.5rem; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); width: 100%; max-width: 750px; }
        h1 { color: var(--primary-color); text-align: center; margin-top: 0; margin-bottom: 1rem; }
        .header-actions { text-align: center; margin-bottom: 2.5rem; }
        #clearHistoryBtn { background-color: #555; color: white; padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 15px; border: none; cursor: pointer; transition: background-color 0.2s; }
        #clearHistoryBtn:hover { background-color: var(--error-color); }
        .lang-selector { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 2rem; gap: 1rem;}
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 0.75rem; color: var(--subtle-text); font-weight: bold;}
        select, textarea { width: 100%; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: #2c2c2c; color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.25); }
        textarea { resize: vertical; min-height: 120px; }
        .buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
        button { padding: 1rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        button:active { transform: scale(0.98); }
        #speakBtn { background-color: var(--secondary-color); color: var(--main-bg); }
        #speakBtn.listening { background-color: var(--error-color); }
        #translateBtn { background-color: var(--primary-color); color: var(--main-bg); }
        .swap-controls { display: flex; flex-direction: column; gap: 0.75rem; align-items: center; }
        .swap-controls button { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); font-size: 1.5rem; padding: 0.5rem 1rem; display: flex; align-items: center; justify-content: center; }
        #roleToggleBtn { font-size: 0.8rem; border-radius: 50%; width: 50px; height: 50px; }
        button:disabled { background-color: #444; color: #888; cursor: not-allowed; }
        #historyContainer { margin-top: 2.5rem; max-height: 40vh; overflow-y: auto; padding-right: 1rem; }
        .history-item { margin-bottom: 1.5rem; background-color: #2c2c2c; padding: 1rem 1.5rem; border-radius: 8px; }
        .history-item p { margin: 0.5rem 0; word-wrap: break-word; }
        .history-item .role-label { color: var(--subtle-text); font-size: 0.9em; font-weight: bold; }
        .history-item .text { font-size: 1.1em; }
        .history-item .actions { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .actions button { font-size: 0.8rem; padding: 0.4rem 0.8rem; color: white; }
        .actions .summarizeBtn { background-color: #3f51b5; }
        .actions .explainBtn { background-color: #4CAF50; }
        .actions .signLangBtn { background-color: #ff9800; }
        #signLanguageContainer { border: 2px dashed #444; margin-top: 1.5rem; padding: 1rem; min-height: 250px; display: none; flex-direction: column; justify-content: center; align-items: center; color: #666; text-align: center; border-radius: 8px; }
        #signLanguageVideo { max-width: 100%; height: 200px; border-radius: 8px; background-color: black; }
        #signLanguageWord { margin-top: 0.5rem; font-weight: bold; color: var(--secondary-color); font-size: 1.2rem; }
        .loader { text-align: center; display: none; margin-top: 1rem; color: var(--secondary-color); }
        audio { width: 100%; margin-top: 1rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #333; padding: 2rem; border-radius: 8px; max-width: 500px; width: 80%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .modal-content h3 { margin-top: 0; color: var(--primary-color); }
        .modal-content .lang-section { margin-bottom: 1rem; }
        .modal-content .lang-label { font-weight: bold; color: var(--secondary-color); }
        .modal-close { float: right; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="container">
            <h1>Healthcare Translation</h1>
            <div class="header-actions"><button id="clearHistoryBtn">Clear History</button></div>
            <div class="lang-selector">
                <div class="form-group"><label id="leftRoleLabel"></label><select id="leftLangSelect"> <option value="en">English</option> <option value="es">Spanish</option> <option value="fr">French</option> <option value="de">German</option> <option value="hi">Hindi</option> <option value="ta">Tamil</option> <option value="ar">Arabic</option> <option value="bn">Bengali</option> <option value="zh-cn">Chinese (Simplified)</option> <option value="pt">Portuguese</option> <option value="ru">Russian</option> <option value="ja">Japanese</option> <option value="ko">Korean</option> <option value="it">Italian</option> </select></div>
                <div class="swap-controls"><button id="roleToggleBtn" title="Toggle Roles">ðŸ©º/ðŸ‘¤</button><button id="langSwapBtn" title="Swap Languages">â‡„</button></div>
                <div class="form-group"><label id="rightRoleLabel"></label><select id="rightLangSelect"> <option value="ta">Tamil</option> <option value="es">Spanish</option> <option value="fr">French</option> <option value="de">German</option> <option value="hi">Hindi</option> <option value="en">English</option> <option value="ar">Arabic</option> <option value="bn">Bengali</option> <option value="zh-cn">Chinese (Simplified)</option> <option value="pt">Portuguese</option> <option value="ru">Russian</option> <option value="ja">Japanese</option> <option value="ko">Korean</option> <option value="it">Italian</option> </select></div>
            </div>
            <div class="form-group"><label for="inputText">Text to Translate</label><textarea id="inputText" placeholder="Enter text or use the microphone..."></textarea></div>
            <div class="buttons"><button id="speakBtn">Start Speaking</button><button id="translateBtn">Translate & Speak</button></div>
            <div id="signLanguageContainer"><p>Sign Language videos will appear here.</p></div>
            <div class="loader" id="loader">Processing...</div>
            <div id="historyContainer"></div>
            <audio id="audioPlayer" controls></audio>
        </div>
    </div>
    <div id="aiModal" class="modal-overlay"> <div class="modal-content"><span class="modal-close" id="modalCloseBtn">&times;</span><h3 id="modalTitle">AI Insight</h3><div id="modalBody"></div></div> </div>
    <script>
        const el = {};
        const ids = ['speakBtn', 'translateBtn', 'inputText', 'historyContainer', 'audioPlayer', 'loader', 'clearHistoryBtn', 'leftRoleLabel', 'rightRoleLabel', 'leftLangSelect', 'rightLangSelect', 'langSwapBtn', 'roleToggleBtn', 'aiModal', 'modalCloseBtn', 'modalTitle', 'modalBody', 'signLanguageContainer'];
        ids.forEach(id => el[id] = document.getElementById(id));
        
        let state = { left: { role: 'Doctor' }, right: { role: 'Patient' } };
        function updateUI() { el.leftRoleLabel.textContent = state.left.role; el.rightRoleLabel.textContent = state.right.role; }
        
        el.langSwapBtn.addEventListener('click', () => { const temp = el.leftLangSelect.value; el.leftLangSelect.value = el.rightLangSelect.value; el.rightLangSelect.value = temp; });
        el.roleToggleBtn.addEventListener('click', () => { const temp = state.left.role; state.left.role = state.right.role; state.right.role = temp; updateUI(); });
        el.clearHistoryBtn.addEventListener('click', () => { el.historyContainer.innerHTML = ''; el.audioPlayer.src = ''; el.signLanguageContainer.style.display = 'none'; });
        el.modalCloseBtn.addEventListener('click', () => { el.aiModal.style.display = 'none'; });
        el.aiModal.addEventListener('click', (e) => { if (e.target === el.aiModal) { el.aiModal.style.display = 'none'; } });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const r = new SpeechRecognition(); r.continuous = true; r.interimResults = true;
            el.speakBtn.addEventListener('click', () => { if (el.speakBtn.classList.contains('listening')) { r.stop(); } else { el.inputText.value = ''; r.lang = el.leftLangSelect.value; r.start(); } });
            r.onstart = () => { el.speakBtn.textContent = 'Stop Recording'; el.speakBtn.classList.add('listening'); };
            r.onend = () => { el.speakBtn.textContent = 'Start Speaking'; el.speakBtn.classList.remove('listening'); };
            r.onresult = (e) => { el.inputText.value = Array.from(e.results).map(res => res[0]).map(res => res.transcript).join(''); };
            r.onerror = (e) => { console.error("Speech error:", e.error); alert(`Speech error: ${e.error}`); };
        } else { el.speakBtn.disabled = true; el.speakBtn.textContent = 'Mic Not Supported'; }

        el.translateBtn.addEventListener('click', async () => {
            if (!el.inputText.value) { alert('Please enter text first.'); return; }
            el.loader.style.display = 'block'; el.translateBtn.disabled = true;
            try {
                const fd = new FormData(); fd.append('text', el.inputText.value); fd.append('input_lang_code', el.leftLangSelect.value); fd.append('output_lang_code', el.rightLangSelect.value);
                const res = await fetch('/translate/', { method: 'POST', body: fd });
                if (!res.ok) throw new Error('Translation failed');
                const data = await res.json();
                addHistoryItem(state.left.role, data.original_text, state.right.role, data.translated_text, data.original_lang_code, data.output_lang_code);
                el.inputText.value = '';
                const ttsRes = await fetch('/text-to-speech/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: data.translated_text, lang_code: data.output_lang_code }) });
                if (ttsRes.ok) { const blob = await ttsRes.blob(); el.audioPlayer.src = URL.createObjectURL(blob); try { await el.audioPlayer.play(); } catch (err) { console.error("Autoplay failed:", err); } }
            } catch (err) { console.error('Processing error:', err); alert('An error occurred.'); } finally { el.loader.style.display = 'none'; el.translateBtn.disabled = false; }
        });

        el.historyContainer.addEventListener('click', async (event) => {
            const button = event.target;
            if (!button.dataset.action) return;
            const text = button.dataset.text;
            const originalLang = button.dataset.originalLang;
            const targetLang = button.dataset.targetLang;
            const action = button.dataset.action;

            button.textContent = '...'; button.disabled = true;
            try {
                if (action === 'summarize' || action === 'explain') {
                    const endpoint = action === 'summarize' ? '/summarize/' : '/explain-medication/';
                    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, original_lang: originalLang, target_lang: targetLang }) });
                    if (!res.ok) { const err = await res.json(); throw new Error(err.detail); }
                    const data = await res.json();
                    const title = action === 'summarize' ? 'AI Summary' : 'AI Medication Explainer';
                    const resKey1 = action === 'summarize' ? 'summary_original_lang' : 'explanation_original_lang';
                    const resKey2 = action === 'summarize' ? 'summary_target_lang' : 'explanation_target_lang';
                    showModal(title, data[resKey1], data[resKey2], originalLang, targetLang);
                } else if (action === 'sign') {
                    await playSignLanguage(text);
                }
            } catch (err) { console.error('AI feature error:', err); alert(`Failed: ${err.message}`); } finally {
                const originalText = { summarize: 'Summarize', explain: 'Explain Medication', sign: 'Show in Sign Language'};
                button.textContent = originalText[action];
                button.disabled = false;
            }
        });

        // --- NEW: ROBUST SIGN LANGUAGE PLAYER ---
        async function playSignLanguage(text) {
            el.signLanguageContainer.style.display = 'flex';
            el.signLanguageContainer.innerHTML = `<div class="loader">Loading sign videos...</div>`;
            try {
                const res = await fetch('/generate-sign-language/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: text }) });
                if (!res.ok) throw new Error('Could not fetch sign language data.');
                const data = await res.json();
                
                el.signLanguageContainer.innerHTML = ''; // Clear loader
                const videoEl = document.createElement('video');
                videoEl.id = 'signLanguageVideo';
                videoEl.muted = true; // Autoplay works best when muted
                const wordEl = document.createElement('p');
                wordEl.id = 'signLanguageWord';
                el.signLanguageContainer.append(videoEl, wordEl);

                for (const sign of data.signs) {
                    wordEl.textContent = sign.word;
                    if (sign.url) {
                        videoEl.src = sign.url;
                        videoEl.load();
                        try {
                            await videoEl.play();
                            await new Promise(resolve => {
                                const onEnded = () => {
                                    videoEl.removeEventListener('ended', onEnded);
                                    resolve();
                                };
                                videoEl.addEventListener('ended', onEnded);
                            });
                        } catch (err) {
                            console.error(`Could not play video for "${sign.word}":`, err);
                            await new Promise(resolve => setTimeout(resolve, 500)); // Pause if play fails
                        }
                    } else {
                        videoEl.src = ''; // Clear video for unfound words
                        await new Promise(resolve => setTimeout(resolve, 750)); // Pause for unfound words
                    }
                }
                el.signLanguageContainer.innerHTML = '<p>Sign language sequence finished.</p>';
            } catch (err) {
                el.signLanguageContainer.innerHTML = `<p style="color: var(--error-color);">${err.message}</p>`;
            }
        }

        function addHistoryItem(fromRole, fromText, toRole, toText, fromLang, toLang) {
            const item = document.createElement('div'); item.className = 'history-item';
            item.innerHTML = `
                <p class="role-label">${fromRole} (${fromLang}):</p><p class="text">${fromText}</p>
                <p class="role-label">${toRole} (${toLang}):</p><p class="text translated">${toText}</p>
                <div class="actions">
                    <button class="summarizeBtn" data-action="summarize" data-text="${toText}" data-original-lang="${fromLang}" data-target-lang="${toLang}">Summarize</button>
                    <button class="explainBtn" data-action="explain" data-text="${toText}" data-original-lang="${fromLang}" data-target-lang="${toLang}">Explain Medication</button>
                    <button class="signLangBtn" data-action="sign" data-text="${toText}">Show in Sign Language</button>
                </div>`;
            el.historyContainer.prepend(item);
        }

        function showModal(title, content1, content2, lang1, lang2) {
            el.modalTitle.textContent = title;
            el.modalBody.innerHTML = `<div class="lang-section"><p class="lang-label">${lang1.toUpperCase()}:</p><p>${content1}</p></div><div class="lang-section"><p class="lang-label">${lang2.toUpperCase()}:</p><p>${content2}</p></div>`;
            el.aiModal.style.display = 'flex';
        }
        
        updateUI();
    </script>
</body>
</html>